<!-- Search Modal Component -->
<div id="search-modal" class="search-modal" aria-hidden="true">
  <div class="search-overlay" data-search-close></div>
  <div class="search-container glass-card">
    <div class="search-header">
      <div class="search-input-wrapper">
        <svg
          class="search-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.3-4.3" />
        </svg>
        <input
          type="text"
          id="search-input"
          class="search-input"
          placeholder="Tìm kiếm bài viết, dự án..."
          autocomplete="off"
        />
        <kbd class="search-kbd">ESC</kbd>
      </div>
    </div>
    <div id="search-results" class="search-results">
      <div class="search-empty">
        <p>Nhập từ khóa để tìm kiếm...</p>
      </div>
    </div>
  </div>
</div>

<style>
  /* ===== Search Modal ===== */
  .search-modal {
    position: fixed;
    inset: 0;
    z-index: var(--z-modal);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--transition-fast),
      visibility var(--transition-fast);
  }

  .search-modal.active {
    opacity: 1;
    visibility: visible;
  }

  .search-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }

  .search-container {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: 0 var(--space-4);
    background: rgba(255, 255, 255, 0.95);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-2xl);
    overflow: hidden;
    transform: translateY(-20px);
    transition: transform var(--transition-fast);
  }

  [data-theme="dark"] .search-container {
    background: rgba(17, 24, 39, 0.95);
  }

  .search-modal.active .search-container {
    transform: translateY(0);
  }

  /* ===== Search Input ===== */
  .search-header {
    padding: var(--space-4);
    border-bottom: 1px solid var(--glass-border);
  }

  .search-input-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .search-icon {
    width: 20px;
    height: 20px;
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  .search-input {
    flex: 1;
    background: transparent;
    border: none;
    font-size: var(--text-lg);
    color: var(--color-text);
    outline: none;
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  .search-kbd {
    padding: var(--space-1) var(--space-2);
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-family: var(--font-code);
    color: var(--color-text-muted);
  }

  /* ===== Search Results ===== */
  .search-results {
    max-height: 400px;
    overflow-y: auto;
  }

  .search-empty {
    padding: var(--space-8);
    text-align: center;
    color: var(--color-text-muted);
  }

  .search-result-item {
    display: block;
    padding: var(--space-4);
    border-bottom: 1px solid var(--glass-border);
    transition: background var(--transition-fast);
  }

  .search-result-item:last-child {
    border-bottom: none;
  }

  .search-result-item:hover,
  .search-result-item.active {
    background: rgba(245, 158, 11, 0.1);
  }

  .result-title {
    font-weight: var(--font-semibold);
    color: var(--color-text);
    margin-bottom: var(--space-1);
  }

  .result-excerpt {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .result-meta {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-text-light);
  }

  .result-type {
    padding: var(--space-0-5) var(--space-2);
    background: rgba(245, 158, 11, 0.15);
    border-radius: var(--radius-full);
    color: var(--amber-600);
    font-weight: var(--font-medium);
  }

  [data-theme="dark"] .result-type {
    color: var(--amber-400);
  }

  .no-results {
    padding: var(--space-8);
    text-align: center;
    color: var(--color-text-muted);
  }

  /* ===== Scrollbar ===== */
  .search-results::-webkit-scrollbar {
    width: 6px;
  }

  .search-results::-webkit-scrollbar-track {
    background: transparent;
  }

  .search-results::-webkit-scrollbar-thumb {
    background: var(--glass-border);
    border-radius: var(--radius-full);
  }
</style>

<script>
  (function () {
    let searchIndex = null;
    let fuse = null;
    const modal = document.getElementById("search-modal");
    const input = document.getElementById("search-input");
    const results = document.getElementById("search-results");
    let activeIndex = -1;

    // Load search index
    async function loadSearchIndex() {
      if (searchIndex) return;
      try {
        const response = await fetch("/index.json");
        searchIndex = await response.json();
        fuse = new Fuse(searchIndex, {
          keys: ["title", "summary", "content", "tags"],
          threshold: 0.3,
          includeScore: true,
          minMatchCharLength: 2,
        });
      } catch (error) {
        console.error("Failed to load search index:", error);
      }
    }

    // Open modal
    function openSearch() {
      modal.classList.add("active");
      modal.setAttribute("aria-hidden", "false");
      input.focus();
      loadSearchIndex();
      document.body.style.overflow = "hidden";
    }

    // Close modal
    function closeSearch() {
      modal.classList.remove("active");
      modal.setAttribute("aria-hidden", "true");
      input.value = "";
      results.innerHTML =
        '<div class="search-empty"><p>Nhập từ khóa để tìm kiếm...</p></div>';
      activeIndex = -1;
      document.body.style.overflow = "";
    }

    // Search and display results
    function performSearch(query) {
      if (!fuse || query.length < 2) {
        results.innerHTML =
          '<div class="search-empty"><p>Nhập từ khóa để tìm kiếm...</p></div>';
        return;
      }

      const searchResults = fuse.search(query).slice(0, 10);

      if (searchResults.length === 0) {
        results.innerHTML =
          '<div class="no-results"><p>Không tìm thấy kết quả cho "<strong>' +
          query +
          '</strong>"</p></div>';
        return;
      }

      results.innerHTML = searchResults
        .map((result, index) => {
          const item = result.item;
          const section =
            item.slug && item.slug.startsWith("/projects") ? "Project" : "Blog";
          return `
        <a href="${item.slug}" class="search-result-item${
            index === 0 ? " active" : ""
          }" data-index="${index}">
          <div class="result-title">${item.title}</div>
          <div class="result-excerpt">${item.summary || ""}</div>
          <div class="result-meta">
            <span class="result-type">${section}</span>
            <span>${item.date || ""}</span>
          </div>
        </a>
      `;
        })
        .join("");

      activeIndex = 0;
    }

    // Update active result
    function updateActive(newIndex) {
      const items = results.querySelectorAll(".search-result-item");
      if (items.length === 0) return;

      items.forEach((item) => item.classList.remove("active"));
      activeIndex = Math.max(0, Math.min(newIndex, items.length - 1));
      items[activeIndex].classList.add("active");
      items[activeIndex].scrollIntoView({ block: "nearest" });
    }

    // Event listeners
    if (modal && input) {
      // Keyboard shortcut to open (Ctrl+K or Cmd+K)
      document.addEventListener("keydown", function (e) {
        if ((e.ctrlKey || e.metaKey) && e.key === "k") {
          e.preventDefault();
          openSearch();
        }

        if (modal.classList.contains("active")) {
          if (e.key === "Escape") {
            closeSearch();
          } else if (e.key === "ArrowDown") {
            e.preventDefault();
            updateActive(activeIndex + 1);
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            updateActive(activeIndex - 1);
          } else if (e.key === "Enter") {
            e.preventDefault();
            const activeItem = results.querySelector(
              ".search-result-item.active"
            );
            if (activeItem) {
              window.location.href = activeItem.href;
            }
          }
        }
      });

      // Click overlay to close
      modal
        .querySelector("[data-search-close]")
        .addEventListener("click", closeSearch);

      // Search on input
      input.addEventListener("input", function (e) {
        performSearch(e.target.value.trim());
      });
    }

    // Expose openSearch function globally
    window.openSearch = openSearch;
  })();
</script>
